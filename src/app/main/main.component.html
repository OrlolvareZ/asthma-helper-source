<p>
    <mat-toolbar color="primary">
        <span>INHLR Monitor</span>
        <span class="toolbar-spacer"></span>
        <button mat-icon-button [matMenuTriggerFor]="menu">
            <mat-icon>menu</mat-icon>
        </button>
        <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="openEmailDialog(emailView)">
                <mat-icon fontIcon="group"/>
                <span>Gestionar contactos de confianza</span>
            </button>
        </mat-menu>
    </mat-toolbar>
</p>

<div
    class="container"
    [class.flex-center]="isSyncing"
>

    @if (isSyncing || isUpdatingContacts) {
    
        <div class="flex-center col appear">
            <mat-progress-spinner
                class="flex sp-bottom"
                mode="indeterminate"
            />
            <p class="flex">
                @if (isSyncing) {
                    Obteniendo datos de tu
                    <span class="inhlr">&nbsp;INHLR</span>...
                }
                @else if (isUpdatingContacts) {
                    Actualizando tus contactos
                }
            </p>
        </div>
    
    }
    @else {



    }

</div>

<ng-template #emailView>

    <h1 mat-dialog-title>Contactos guardados</h1>

    <mat-divider/>

    <div mat-dialog-content>

        @if (isLoadingContacts || isUpdatingContacts) {
            <mat-progress-bar class="appear" mode="indeterminate"/>
        }
        @else if (!wasAbleToFetchContacts) {
            <div class="center-container appear">
                <h1>Hubo un error al cargar tus contactos ðŸ˜¢</h1>
                <p>Por favor asegÃºrate de que tu <span class="inhlr">INHLR</span> estÃ© encendido</p>
            </div>
        }
        @else {

            @if (contactsFormArray.length === 0) {
                <p class="appear">
                    Â¡No tienes contactos guardados aÃºn! ðŸ˜¯
                </p>
                <p class="hint">
                    Agrega hasta 5 contactos de confianza para que puedan
                    ser notificados en caso de emergencia
                </p>
            }

            <form [formGroup]="fg" class="appear col">
                @for (contact of contactsFormArray.controls; track contact){
                    <div formArrayName="contacts" class="row appear">
                        <mat-form-field class="flex">
                            <mat-label>Contacto #{{ $index + 1 }}</mat-label>
                            <input
                                matInput
                                formControlName="{{$index}}"
                                type="email"
                            />
                            @if (contact.hasError('email')) {
                                <mat-error>
                                    Por favor ingresa un correo vÃ¡lido
                                </mat-error>
                            }
                            @else if (contact.hasError('required')) {
                                <mat-error>
                                    Este campo es requerido
                                </mat-error>
                            }
                        </mat-form-field>
                        <button
                            class="flex"
                            mat-icon-button
                            color="warn"
                            (click)="removeContact($index)"
                        >
                            <mat-icon>delete</mat-icon>
                        </button>
                    </div>
                }
            </form>

            @if (contactsFormArray.length < 5) {
                <button
                    mat-raised-button
                    color="primary"
                    (click)="addContact()"
                >
                    <mat-icon>add</mat-icon>
                    <span>Agregar contacto</span>
                </button>
            }

        }

    </div>

    <mat-divider/>

    <div mat-dialog-actions>
        <button
            mat-button
            mat-dialog-close
            [disabled]="isUpdatingContacts"
        >
            Volver
        </button>
        <button
            color="accent"
            mat-flat-button
            (click)="saveContacts()"
            [disabled]="isLoadingContacts || isUpdatingContacts || fg.pristine || fg.invalid"
        >
            Actualizar
        </button>
    </div>

</ng-template>
